<!DOCTYPE html>
<html>
<head>
  <script
			  src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<!--Google Maps Places API library-->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtBtC_koG-Cmbikl2oAbZwXNxBjH_3gEQ&libraries=places"></script>
        <title>Municipality home page </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body {
  font-family: "Lato", sans-serif;
}

/* Fixed sidenav, full height */
.sidenav {
	
  height: 100%;
  width: 200px;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: #E59866;
  border-color: #2196F3;
  overflow-x: hidden;
  padding-top: 25px;
}

/* Style the sidenav links and the dropdown button */
.sidenav a, .dropdown-btn {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
    font-size: 28px;
  color: #2C3E50;
  display: block;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  outline: none;
}

/* On mouse-over */
.sidenav a:hover, .dropdown-btn:hover {
  color: #f1f1f1;
}

/* Main content */
.main {
  margin-left: 200px; /* Same as the width of the sidenav */
  font-size: 20px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}

/* Add an active class to the active dropdown button */
.active {
  background-color: #EC7063 ;
  color: white;
}

/* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
.dropdown-container {
  display: none;
  background-color: #D5F5E3 ;
  padding-left: 8px;
}

/* Optional: Style the caret down icon */
.fa-caret-down {
  float: right;
  padding-right: 8px;
}

/* Some media queries for responsiveness */
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
#header {
    background-color:#BDB76B;
    color: Black;
    text-align:center;
    padding:4px;
}

#footer {
    background-color:black;
    color:black;
    clear:both;
    text-align:center;
	padding:5px;	 	 
}

</style>
</head>
<body>

<div id="header">
<!--Welcome!! Municipality Admin-->
<h1><i id="italic_landing"><i></h1>
</div>

<div class="sidenav">

	
  <a href="#about">About</a>
  
  <button class="dropdown-btn">Services</a>
  <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container">
    <a href="#">Link 1</a>
    <a href="#">Link 2</a>
    <a href="#">Link 3</a>
  </div>
  
  <button class="dropdown-btn">Clients</a>
  <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container">
    <a href="#">Link 1</a>
    <a href="#">Link 2</a>
    <a href="#">Link 3</a>
  </div>
  
    <button class="dropdown-btn">Dashboard 
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container">
    <a href="#">Link 1</a>
    <a href="#">Link 2</a>
    <a href="#">Link 3</a>
  </div>
  <a href="#contact"><i class="fa fa-search">Search</i></a>
  <a href="#contact">Calender</a>
</div>

<div class="main">
  <div id="price-show-div">
    <div>Current Cost per KM</div>
  <input id="price-div"/>
  <button id="button-change-price">Change</button>
  </div>

  <div id="municipalities-updates">
    Realtime Municipalities Updates
    <table id="municipalities-table">
      <tr>
        <th>Municipality</th>
        <th>Province</th>
        <th>Region</th>
        <th>Postcode</th>
        <th>Location</th>
        <th>Price</th>
      </tr>
    </table>
  </div>
  <span></span>
  <div>
    Realtime Parking Places Updates
    <table id="parking-places-table">
      <tr>
        <th>Municipality</th>
        <th>Address</th>
        <th>Status</th>
      </tr>
    </table>
  </div>
  <span></span>
  <div>
    Realtime Police officers Updates
    <table id="police-officers-table">
      <tr>
        <th>Municipality</th>
        <th>Name</th>
        <th>Email</th>
        <th>Badge</th>
        <th>Status</th>
      </tr>
    </table>
  <span></span>
  <div id="add-parking-place-div">
    <div>add a new Parking Place</div>
    <div>
      <input type="text" id="autocomplete"/>
    </div>
    <div>
      <button id="button-confirm-parkingplace">Confirm</button>
    </div>
  </div>
  <div id="add-police-officer-div">
    <div>add a new police officer</div>
    <input placeholder="name" id="name">
    <input placeholder="email" id="email">
    <input placeholder="password" id="password">
    <input placeholder="badge" id="badge">
    <div>
      <div>
        <button id="button-confirm-officer">Confirm</button>
      </div>
    </div>
  </div>
  
</div>

<script>
/* Loop through all dropdown buttons to toggle between hiding and showing its dropdown content - This allows the user to have multiple dropdowns without any conflict */
var dropdown = document.getElementsByClassName("dropdown-btn");
var i;

for (i = 0; i < dropdown.length; i++) {
  dropdown[i].addEventListener("click", function() {
  this.classList.toggle("active");
  var dropdownContent = this.nextElementSibling;
  if (dropdownContent.style.display === "block") {
  dropdownContent.style.display = "none";
  } else {
  dropdownContent.style.display = "block";
  }
  });
}
</script>
<script>
  var autocomplete;
  $(function() {
    autocomplete = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */ (
                document.getElementById('autocomplete')), {
              
            }
            );
  });
  async function forwardGeocoding(place) {
    let response = await fetch("http://www.mapquestapi.com/geocoding/v1/address?key=EQGn6RdZOa3LaRlvqT3QYhpeCwKjoLhO", {
      method: "post",
      headers: new Headers({
        "Content-Type": "application/json"
      }),
      body: JSON.stringify({
        location: place
      })
    });
    if(response.ok) {
      let body = await response.json();
      console.log(body);
      return body.results[0].locations[0].latLng;
    }
  }
</script>
<script>
  async function addOfficer() {
    var select = document.getElementById('officer-select-municipality');
    let respose = await fetch('/api/dashboard/officers',{
      method: "post",
      headers: new Headers({
        "Content-Type": "application/json",
        "Cookie": document.cookie
      }),
      body: JSON.stringify({
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        badge: document.getElementById('badge').value
      })
    });
    if(respose.ok) {
      
    }
  }

  async function addParkingPlace() {
    var select = document.getElementById('parkingplace-select-municipality');
    var address = document.getElementById('autocomplete').value;
    var geocode = await forwardGeocoding(address);
    let respose = await fetch('/api/dashboard/parkingplaces',{
      method: "post",
      headers: new Headers({
        "Content-Type": "application/json",
        "Cookie": document.cookie
      }),
      body: JSON.stringify({
        location: {
          lat: geocode.lat,
          lng: geocode.lng,
          address: address
        }
      })
    });
    if(respose.ok) {
      
    }
  }

  async function changePricePerMinute() {
    var newPrice = document.getElementById('price-div').value;
    let respose = await fetch('/api/dashboard/municipalities',{
      method: "put",
      headers: new Headers({
        "Content-Type": "application/json",
        "Cookie": document.cookie
      }),
      body: JSON.stringify({
        pricePerMinute: newPrice
      })
    });
    if(respose.ok) {
      
    }
  }
 
</script>
<script>
  async function municipalityPriceFetch() {
    let response = await fetch('/api/dashboard/municipalities/', {
      method: "get",
      headers: new Headers({
        "Cookie": document.cookie
      })
    });
    if(response.ok) {
      let body = await response.json();
      console.log(body)
      document.getElementById('price-div').value = body.pricePerMinute;
    }
  }

  async function municipalitiesDataFetch() {
    let response = await fetch('/api/dashboard/municipalities', {
      method: "get",
      headers: new Headers({
        "Cookie": document.cookie
      })
    });
    if(response.ok) {
      let body = await response.json();
      var table = document.getElementById('municipalities-table');
      var rows = table.getElementsByTagName('tr');
      while(rows.length > 1) {
        rows[1].parentNode.removeChild(rows[1]);
      }
      body.forEach(element => {
        //populate the table
        var row = document.createElement('tr');
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.name);
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.province);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.region);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.postcode);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode('('+element.location.lat+','+element.location.lng+')');
        //cellText = '('+cellText.lat+','+cellText.lng+')';
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.pricePerMinute);
        cell.appendChild(cellText);
        row.appendChild(cell);
        table.appendChild(row);
      });
    }
    setTimeout(municipalitiesDataFetch,5000);
  }

  async function officersDataFetch() {
    let response = await fetch('/api/dashboard/officers?detailed=true',{
      method: "get",
      headers: new Headers({
        "Cookie": document.cookie
      })
    });
    if(response.ok) {
      let body = await response.json();
      var table = document.getElementById('police-officers-table');
      var rows = table.getElementsByTagName("tr");
      while(rows.length > 1) {
        rows[1].parentNode.removeChild(rows[1]);
      }
      body.forEach(element => {
        //populate the table
        var row = document.createElement('tr');
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.municipality);
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.name);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.email);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.badge);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.status);
        cell.appendChild(cellText);
        row.appendChild(cell);
        table.appendChild(row);
      });
    }
    setTimeout(officersDataFetch,5000);
  }

  async function parkingPlacesDataFetch() {
    let response = await fetch('/api/dashboard/parkingplaces?detailed=true',{
      method: "get",
      headers: new Headers({
        "Cookie": document.cookie
      })
    });
    if(response.ok) {
      let body = await response.json();
      var table = document.getElementById('parking-places-table');
      var rows = table.getElementsByTagName("tr");
      while(rows.length > 1) {
        rows[1].parentNode.removeChild(rows[1]);
      }
      body.forEach(element => {
        //populate the table
        var row = document.createElement('tr');
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.municipality);
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cellText = document.createTextNode(element.location.address);
        var cell = document.createElement('td');
        cell.appendChild(cellText);
        row.appendChild(cell);
        var cell = document.createElement('td');
        var cellText = document.createTextNode(element.status);
        cell.appendChild(cellText);
        row.appendChild(cell);
        table.appendChild(row);
      });
    }
    setTimeout(parkingPlacesDataFetch,5000);
  }
</script>
<script>
  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
};
</script>
<script>
  $(function (){
    if(parseJwt($.cookie('auth_token')).domain === '*'){
      document.getElementById('italic_landing').innerHTML = 'Welcome!! Parking Company Admin';
      document.getElementById('municipalities-updates').style.display = 'block';
      document.getElementById('price-show-div').style.display = 'none';
      document.getElementById('add-police-officer-div').style.display = 'none';
      document.getElementById('add-parking-place-div').style.display = 'none';
      setTimeout(municipalitiesDataFetch,1000);
      setTimeout(officersDataFetch,1000);
      setTimeout(parkingPlacesDataFetch,1000);
      window.document.title = 'Parking Company Home Page';
    } else {
      document.getElementById('italic_landing').innerHTML = 'Welcome!! Municipality Admin';
      document.getElementById('municipalities-updates').style.display = 'none';
      document.getElementById('price-show-div').style.display = 'block';
      document.getElementById('add-police-officer-div').style.display = 'block';
      document.getElementById('add-parking-place-div').style.display = 'block';
      $('#button-confirm-parkingplace').on('click',addParkingPlace);
      $('#button-confirm-officer').on('click',addOfficer);
      $('#button-change-price').on('click',changePricePerMinute);
      setTimeout(officersDataFetch,1000);
      setTimeout(parkingPlacesDataFetch,1000);
      setTimeout(municipalityPriceFetch,1000);
      window.document.title = 'Municipality Home Page';
    }
    
  })
</script>
<script>
  
</script>
</body>
</html> 
